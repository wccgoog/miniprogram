## 适用范围
该文档适用于友盟+支付宝小程序统计SDK 1.0.0 及以上版本，并且支付宝版本需大于10.1.52版本，且在支付宝小程序开放平台中勾选 jsAPI基础包。

# 一、支付宝小程序统计SDK快速集成
![支付宝小程序接入流程图](https://img.alicdn.com/tfs/TB16xHfzYvpK1RjSZFqXXcXUVXa-2356-214.png)

## 1. 注册友盟+账号
登录友盟+官网，按照引导注册友盟+账号
![友盟账号注册](https://img.alicdn.com/tfs/TB1XB0EB7voK1RjSZFwXXciCFXa-865-397.png)

特别提醒：我们建议开发者在注册账号时使用企业邮箱，避免使用个人邮箱注册，防止由于个人离职带来的问题，建议使用的账号形式 ：umeng@企业域名、apps@企业域名、dev@企业域名

## 2. Appkey申请——为您的小程序申请新的Appkey
登录[友盟+官网](http://www.umeng.com/ "友盟+官网")，并在UAPP-AI版本中的[管理](https://mobile.umeng.com/platform/config/apps )页面的左侧导航中添加新应用，然后获取到Appkey，为下一步集成做准备。
![注册APP](https://img.alicdn.com/tfs/TB1DWMAzCzqK1RjSZFLXXcn2XXa-2778-1420.png)
![获取Appkey](https://img.alicdn.com/tfs/TB1BQejxCzqK1RjSZFjXXblCFXa-2802-1576.png)

## 3. 创建支付宝小程序并接入SDK
### 3.1 安装SDK
```
npm i umtrack-alipay --save
```

### 3.3 为支付宝小程序的*app.js*文件中添加如下代码：
```javascript
import uma from 'umtrack-alipay';

App({
  onLaunch() {
    uma.init('YOUR_APP_KEY', my);      // 务必填入已注册的appKey，不然将无法统计
  },
  onShow() {
    uma.resume();                      // 请务必引入
  },
  onHide() {
    uma.pause();                       // 请务必引入
  },
  globalData: {
    uma                                // 请将uma模块绑定在gloabalData下，以便后续使用
  }
});
```
注意:
  - 以上4个方法是SDK最基本的统计方法，请务必都引入；
  - 请在小程序最出初始化的时候调用`uma.init()`方法，并填入已注册的appKey ，不然无法统计；
  - 为了保证统计的稳定运行，请您在`uma.init()`中请将 `my` 传入；
  - 请您将`uma`绑定在`globalData`下，以便各个页面中可以正确使用SDK接口。

### 3.4 支付宝小程序增加友盟+数据服务域名白名单
![白名单设置](https://img.alicdn.com/tfs/TB1UCpzB9zqK1RjSZFLXXcn2XXa-2322-364.png)

### 3.5 友盟+数据服务功能包勾选
- 请务必在支付宝平台勾选 **“友盟+数据服务”** 功能包，否则将导致无法统计数据

## 4. 基础接口引入
### 4.1 页面信息统计
在每个页面中添加基础数据统计接口：

```javascript
trackPageStart(pageName)/trackPageEnd(pageName) 
```
参数: 
  * pageName(string): 当前页面名称，建议使用英文名称

返回值: 
  * 无

示例：在App中每个页面的`onShow`方法中调用 `getApp().globalData.uma.trackPageStart()`，在`onHide()`方法以及`onUnload()`中调用`getApp().globalData.uma.trackPageEnd()`方法，添加代码如下：

```javascript
Page({
  onShow() {
    // 请将pageName替换成您的页面名称，并建议使用英文命名
    getApp().globalData.uma.trackPageStart('pageName');
  },
  onHide() {
    getApp().globalData.uma.trackPageEnd('pageName');
  },
  onUnload() {
    getApp().globalData.uma.trackPageEnd('pageName');
  }
});
```
**注意：**
- 请确保在所有页面都调用`getApp().globalData.uma.trackPageStart()和getApp().globalData.uma.trackPageEnd()`这两个方法；
- 请成对调用`getApp().globalData.uma.trackPageStart()`和`getApp().globalData.uma.trackPageEnd()`，否则会造成页面路径统计信息丢失；
- 请务必在`onHide()`方法以及`onUnload()`中都调用`getApp().globalData.uma.trackPageEnd()`，否则会造成页面路径统计信息丢失；
- 请在`getApp().globalData.uma.trackPageStart()`以及`getApp().globalData.uma.trackPageEnd()`方法中传入当前页面名称，若不填写页面名称将不会统计此页面的路径信息。


# 二、高级功能
## 1. 自定义事件打点接口及调用说明
```javascript
 trackEvent(id, params)
```
参数：
  * id(string): 事件ID需在官网申请，长度在128个字符内
  * params(object):
    * object: 多参数统计类型

返回值：
  * 无

### 1.1 仅需统计事件，无参数时，可使用如下方法：

```javascript
getApp().globalData.uma.trackEvent('事件ID');
```

### 1.2 需要统计带参数的事件时，可使用如下方法：

```javascript
getApp().globalData.uma.trackEvent('事件ID',{'属性1':'属性值1','属性2':'属性值2'});
```
注意：
1. `params`为`object`类型时，属性值仅支持字符串和数值两种类型;
2. 使用自定义事件功能请先登录U-App[管理](https://mobile.umeng.com/platform/config/apps "管理")页面，点击【应用列表】-> 【应用名称】 -> 【应用设置】 -> 【事件】（子账户由于权限限制可能无法看到”设置”选项，请联系主帐号开通权限。）页面中添加相应的事件id（事件id可用英文或数字，不要使用中文和特殊字符且不能使用英文句号”.”您可以使用下划线”_”），然后服务器才会对相应的事件请求进行处理。
3. 请在SDK初始化之后调用事件。

# 三、SDK成功接入验证方法

该方案仅提供验证是否集成成功的方法，由于在开发环境下可能会存在数据不完整的情况，请您正式发布小程序后在验证数据正确性。
## 1. 小程序开发者工具(IDE) 验证
1. 请保证已经下载安装完成[小程序开发者工具(IDE)](https://docs.alipay.com/mini/ide/download)，并在IDE中打开您的小程序；

2. 按照上述描述方法引入SDK；

3. 进入IDE打开调试工具中的console选项，若看到有 "[umeng] -- 集成SDK成功"提示 即表示SDK集成成功。

4. 若提示" [umeng] -- 请确保已经勾选支付宝功能包中的"友盟+数据服务"功能包！" 请您务必确认已在支付宝开发者中心已经勾选'友盟+数据服务';

注意：
- 提示 "api: getOpenUserData 暂不支持，请在真机调试"，请在手机上验证是否存在该提示，若不存在即可忽略此提示；

# 四、说明事项
1. SDK统计仅仅会在支付宝版本大于等于 **10.1.52** 才能生效，低版本将获取不到统计信息；

2. 慎重调用`my.clearStorage()`以及`my.clearStorageSync()`接口！SDK会将用户相关操作数据缓存在客户端数据存储模块，在特定时间启动发送策略。若调用该接口可导致数据统计不准确的问题；

3. 若用户在使用小程序过程强制关闭支付宝有可能会造成统计数据丢失的情况。



# FAQ:
- Q: 注册应用时，提示应用名称已存在
- A：【友盟+】后台的应用名与实际应用名和包名无关，建议命名为应用名+平台
- Q: 我忘记我的Appkey了，在哪里能查到
- A：登录[管理](http://mobile.umeng.com/apps/setting "管理")页面，在应用列表中点击去集成，即可看到当前应用的Appkey